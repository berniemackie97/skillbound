name: Deploy

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    environment:
      name: Preview
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Vercel secrets
        id: vercel-secrets
        run: |
          if [ -z "${VERCEL_TOKEN}" ] || [ -z "${VERCEL_ORG_ID}" ] || [ -z "${VERCEL_PROJECT_ID}" ]; then
            echo "available=false" >> $GITHUB_OUTPUT
            echo "Vercel secrets are not available; skipping preview deployment."
          else
            echo "available=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup pnpm
        if: steps.vercel-secrets.outputs.available == 'true'
        uses: pnpm/action-setup@v2
        with:
          version: '8.15.0'

      - name: Setup Node.js
        if: steps.vercel-secrets.outputs.available == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Vercel CLI
        if: steps.vercel-secrets.outputs.available == 'true'
        run: pnpm add -g vercel@latest

      - name: Pull Vercel environment
        if: steps.vercel-secrets.outputs.available == 'true'
        run: vercel pull --yes --environment=preview --token=${VERCEL_TOKEN}

      - name: Build project
        if: steps.vercel-secrets.outputs.available == 'true'
        run: vercel build --token=${VERCEL_TOKEN}

      - name: Deploy to Vercel
        if: steps.vercel-secrets.outputs.available == 'true'
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --token=${VERCEL_TOKEN})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "Preview URL: $url"

      - name: Run smoke tests
        if: steps.vercel-secrets.outputs.available == 'true'
        run: |
          # Wait for deployment to be ready
          sleep 10
          # Basic health check
          curl -f ${{ steps.deploy.outputs.url }}/api/health || exit 1

      - name: Comment PR
        if: steps.vercel-secrets.outputs.available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Preview Deployment\n\nâœ… Preview deployed successfully!\n\nðŸ”— **URL:** ${{ steps.deploy.outputs.url }}\n\n---\n*Deployed from commit ${{ github.sha }}*`
            })

  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://skillbound.app
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Vercel secrets
        run: |
          if [ -z "${VERCEL_TOKEN}" ] || [ -z "${VERCEL_ORG_ID}" ] || [ -z "${VERCEL_PROJECT_ID}" ]; then
            echo "Vercel secrets are not available for production deployment."
            exit 1
          fi

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8.15.0'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run all tests
        run: pnpm test

      - name: Install Vercel CLI
        run: pnpm add -g vercel@latest

      - name: Pull Vercel environment
        run: vercel pull --yes --environment=production --token=${VERCEL_TOKEN}

      - name: Build project
        run: vercel build --prod --token=${VERCEL_TOKEN}

      - name: Deploy to Vercel
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${VERCEL_TOKEN})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "Production URL: $url"

      - name: Run production smoke tests
        run: |
          # Wait for deployment to be ready
          sleep 15
          # Health check
          curl -f ${{ steps.deploy.outputs.url }}/api/health || exit 1

      - name: Notify deployment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id,
              state: 'success',
              environment_url: '${{ steps.deploy.outputs.url }}',
              description: 'Production deployment successful'
            })

      - name: Create Sentry release
        if: success()
        run: |
          # Install Sentry CLI
          curl -sL https://sentry.io/get-cli/ | bash
          # Create release
          sentry-cli releases new "${{ github.sha }}"
          sentry-cli releases set-commits "${{ github.sha }}" --auto
          sentry-cli releases finalize "${{ github.sha }}"
          sentry-cli releases deploys "${{ github.sha }}" new -e production
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}